{% if hasNotAcceptCookie %}
    <div class="isolate z-70 "
         data-show-banner="{{ cookieHasSetPreferences() }}"
         data-essential="{{ cookieIsAuthorizedByName('essential') }}"
         data-statistics="{{ cookieIsAuthorizedByName('statistics') }}"
         data-encapsulated="{{ cookieIsAuthorizedByName('encapsulated') }}"
         x-data="{
    isPopupCookieOpen: false,
    showBanner: false,
    essential: false,
    statistics: false,
    encapsulated: false,
    init() {
        // Show banner only if preferences haven't been set
        this.showBanner = this.$el.dataset.showBanner === '' || this.$el.dataset.showBanner === '0' || this.$el.dataset.showBanner === 'false';
        // Load current preferences from data attributes
        this.essential = this.$el.dataset.essential === '1' || this.$el.dataset.essential === 'true';
        this.statistics = this.$el.dataset.statistics === '1' || this.$el.dataset.statistics === 'true';
        this.encapsulated = this.$el.dataset.encapsulated === '1' || this.$el.dataset.encapsulated === 'true';
    },
    togglePopupCookie() {
        this.isPopupCookieOpen = !this.isPopupCookieOpen;
    },
    async acceptAll() {
        this.essential = true
        this.statistics = true
        this.encapsulated = true
        await this.savePreferences()
    },
    async savePreferences() {
        const formData = new FormData()
        formData.append('action', 'set_cookie_action')
        formData.append('nonce', wpData.cookieNonce)
        formData.append('essential', this.essential ? '1' : '0')
        formData.append('encapsulated', this.encapsulated ? '1' : '0')
        formData.append('statistics', this.statistics ? '1' : '0')

        try {
            const response = await fetch(wpData.ajaxUrl, {
                method: 'POST',
                body: formData
            });

            const result = await response.json();

            if (result.success && result.data) {
                console.log('Cookie preferences saved:', result.data);
                // Hide banner and popup
                this.showBanner = false;
                this.isPopupCookieOpen = false;
                // Reload page to apply changes
                window.location.reload();
            } else {
                console.error('Error saving cookie preferences:', result.data?.message || 'Unknown error');
            }
        } catch (error) {
            console.error('Error saving cookie preferences:', error);
        }
    }
}">

        <section x-show="showBanner"
                 x-transition:enter="transition ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4"
                 x-transition:enter-end="opacity-100 translate-y-0"
                 class="fixed max-w-md p-5 mx-auto bg-white border border-gray-200 shadow-2xl left-4 md:left-12 bottom-4 md:bottom-16 rounded-2xl">
            <div class="flex items-start gap-3">
                <span class="text-3xl shrink-0">üç™</span>
                <div class="flex-1">
                    <h4 class="font-bold text-gray-900 text-lg">{{ 'cookie.title'|trans }}</h4>
                    <p class="mt-2 text-gray-700 leading-relaxed">
                        {{ 'cookie.description'|trans }}
                        <a href="/administration/rgpd" class="text-cta-dark hover:underline">
                            {{ 'private.rgpd'|trans }}
                        </a>
                    </p>
                    <div class="flex flex-row sm:flex-row items-stretch sm:items-center gap-2 mt-4">
                        <button @click="togglePopupCookie"
                                type="button"
                                class="cursor-pointer font-medium text-gray-700 hover:text-gray-900 underline transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cta-dark focus-visible:ring-offset-2 rounded">
                            {{ 'cookie.customize'|trans }}
                        </button>
                        <button @click="acceptAll"
                                type="button"
                                class="cursor-pointer bg-cta-dark font-semibold rounded-lg hover:bg-opacity-90 text-white px-5 py-2.5 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-cta-dark focus-visible:ring-offset-2 shadow-md">
                            {{ 'cookie.accept_all'|trans }}
                        </button>
                    </div>
                </div>
            </div>
        </section>
        {% include '@Visit/cookies/_modal.html.twig' %}
    </div>
{% endif %}
